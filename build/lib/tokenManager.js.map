{
  "version": 3,
  "sources": ["../../src/lib/tokenManager.ts"],
  "sourcesContent": ["interface TokenResponse {\n\tsuccess: {\n\t\ttoken: string;\n\t\trefresh_token: string;\n\t\texpires_in: number;\n\t\tsuper_user: number;\n\t\tuserID: number;\n\t\trouteIcon: string;\n\t\treset: number;\n\t\tappMode: string;\n\t};\n}\n\ninterface TokenData {\n\taccessToken: string;\n\trefreshToken: string;\n\tuserId: number;\n\texpiresAt: number;\n}\n\nexport class TokenManager {\n\tprivate tokenData: TokenData | null = null;\n\tprivate refreshingTokenPromise: Promise<string> | null = null;\n\tprivate tokenPromise: Promise<TokenData> | null = null;\n\tprivate refreshLock: Promise<void> | null = null;\n\tprivate releaseRefreshLock: (() => void) | null = null;\n\tprivate baseUrl: string = 'https://connect.paj-gps.de/api/v1/';\n\n\tconstructor(\n\t\tprivate readonly adapter: ioBroker.Adapter,\n\t\tprivate readonly email: string,\n\t\tprivate readonly password: string,\n\t) {\n\t\tif (!email || !password) {\n\t\t\tthrow new Error('Email and password must be provided');\n\t\t}\n\t\tthis.email = email;\n\t\tthis.password = password;\n\t\t//this.tokenPromise = this.initTokenData();\n\t}\n\n\t//\n\tasync getAccessToken(): Promise<string> {\n\t\tthis.adapter.log.debug('[getAccessToken] Entry');\n\n\t\t// Token aus Storage holen\n\t\tthis.tokenData = await this.getStoredTokenData();\n\t\tthis.adapter.log.debug(`[getAccessToken] Loaded token (expires at: ${this.tokenData ? this.showTimeStamp(this.tokenData.expiresAt) : 'N/A'})`);\n\n\t\t// Token noch g\u00FCltig?\n\t\tif (this.tokenData && Date.now() < this.tokenData.expiresAt - 60000) {\n\t\t\tthis.adapter.log.debug('[getAccessToken] Token valid, returning.');\n\t\t\treturn this.tokenData.accessToken;\n\t\t}\n\n\t\t// Wenn Sperre aktiv: warten\n\t\tif (this.refreshLock) {\n\t\t\tthis.adapter.log.debug('[getAccessToken] Refresh in progress, waiting...');\n\t\t\tawait this.refreshLock;\n\n\t\t\t// Nach Warten: g\u00FCltiger Token?\n\t\t\tif (this.tokenData && Date.now() < this.tokenData.expiresAt - 60000) {\n\t\t\t\tthis.adapter.log.debug('[getAccessToken] Got refreshed token after wait.');\n\t\t\t\treturn this.tokenData.accessToken;\n\t\t\t} else {\n\t\t\t\tthis.adapter.log.error('[getAccessToken] No valid token even after waiting!');\n\t\t\t\tthrow new Error('Token refresh failed or timed out');\n\t\t\t}\n\t\t}\n\n\t\t// Jetzt exklusiv Sperre setzen\n\t\tthis.adapter.log.debug('[getAccessToken] Starting exclusive token refresh...');\n\t\tthis.refreshLock = new Promise<void>((resolve) => {\n\t\t\tthis.releaseRefreshLock = resolve;\n\t\t});\n\n\t\ttry {\n\t\t\t// Versuche Refresh mit Refresh-Token\n\t\t\ttry {\n\t\t\t\tthis.adapter.log.info('[getAccessToken] Refreshing token via refresh_token...');\n\t\t\t\tthis.tokenData = await this.getTokenWithRefreshtoken();\n\t\t\t} catch (e) {\n\t\t\t\tthis.adapter.log.warn('[getAccessToken] Refresh failed, doing full login...');\n\t\t\t\tthis.tokenData = await this.getTokenWithLogin();\n\t\t\t}\n\n\t\t\tif (!this.tokenData) {\n\t\t\t\tthrow new Error('Token refresh/login returned no data.');\n\t\t\t}\n\n\t\t\tthis.storeToken();\n\t\t\tthis.adapter.log.info('[getAccessToken] Token obtained successfully.');\n\t\t\treturn this.tokenData.accessToken;\n\n\t\t} finally {\n\t\t\t// Sperre aufheben\n\t\t\tconst release = this.releaseRefreshLock;\n\t\t\tthis.refreshLock = null;\n\t\t\tthis.releaseRefreshLock = null;\n\t\t\tif (release) release();\n\t\t}\n\t}\n\n\t/**\n\t * Login to the API and retrieves the access token.\n\t * @returns {Promise<TokenData>} The token data containing access token, refresh token, and expiration time.\n\t * @throws {Error} If the login fails or the response is invalid.\n\t */\n\tprivate async getTokenWithLogin(): Promise<TokenData> {\n\t\tthis.adapter.log.debug('[getTokenWithLogin#]');\n\t\tconst spezUrl: string = 'login?email=';\n\t\tconst urlBinder: string = '&password=';\n\t\tconst url = [this.baseUrl, spezUrl, encodeURIComponent(this.email), urlBinder, encodeURIComponent(this.password)].join('');\n\n\t\tconst res = await fetch(url, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t});\n\n\t\tthis.adapter.log.info(`[getTokenWithLogin] Response: ${res.status} ${res.statusText}`);\n\t\tif (!res.ok) {\n\t\t\tthrow new Error(`Login failed: ${res.statusText}`);\n\t\t}\n\n\t\tconst data = await res.json() as TokenResponse;\n\n\t\tif (!data.success || !data.success.token || !data.success.refresh_token || !data.success.expires_in || !data.success.userID) {\n\t\t\tthrow new Error('Login response is missing required fields');\n\t\t}\n\n\t\tconst tokenData: TokenData = {\n\t\t\taccessToken: data.success.token,\n\t\t\trefreshToken: data.success.refresh_token,\n\t\t\tuserId: data.success.userID,\n\t\t\t//expiresAt: Date.now() + data.success.expires_in * 1000,\n\t\t\t//expiresAt: Date.now() + 900000, // 15 Minuten Puffer\n\t\t\texpiresAt: Date.now() + 300000, // 5 Minuten\n\t\t}\n\n\t\treturn tokenData;\n\t}\n\n\tprivate async getTokenWithRefreshtoken(): Promise<TokenData> {\n\t\t//private async refreshAccessToken(refreshToken: string): Promise<TokenData> {\n\t\tthis.adapter.log.debug('[getTokenWithRefreshtoken#]');\n\t\tconst spezUrl: string = 'updatetoken?email=';\n\t\tconst urlBinder: string = '&refresh_token=';\n\n\t\t// Check if refreshToken is available\n\n\t\tif (!this.tokenData || !this.tokenData.refreshToken) {\n\t\t\t//if (!refreshToken) {\n\t\t\tthrow new Error('No refresh token available for refreshing access token');\n\t\t}\n\n\t\tconst url = [this.baseUrl, spezUrl, encodeURIComponent(this.email), urlBinder, this.tokenData?.refreshToken].join('');\n\t\t//const url = [this.baseUrl, spezUrl, encodeURIComponent(this.email), urlBinder, refreshToken].join('');\n\n\t\tconst res = await fetch(url, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t});\n\n\t\tthis.adapter.log.info(`[getTokenWithRefreshtoken] Response: ${res.status} ${res.statusText}`);\n\n\t\tif (!res.ok) {\n\t\t\tthrow new Error(`Token refresh failed: ${res.statusText}`);\n\t\t}\n\n\t\tconst data = await res.json() as TokenResponse;\n\t\tif (!data.success || !data.success.token || !data.success.refresh_token || !data.success.expires_in || !data.success.userID) {\n\t\t\tthrow new Error('Login response is missing required fields');\n\t\t}\n\n\t\tconst tokenData: TokenData = {\n\t\t\taccessToken: data.success.token,\n\t\t\trefreshToken: data.success.refresh_token,\n\t\t\tuserId: data.success.userID,\n\t\t\t//expiresAt: Date.now() + data.success.expires_in * 1000,\n\t\t\t//expiresAt: Date.now() + 900000, // 15 Minuten Puffer\n\t\t\texpiresAt: Date.now() + 300000, // 5 Minuten Puffer\n\t\t}\n\t\treturn tokenData;\n\t}\n\n\tprivate storeToken(): void {\n\t\t//private async storeToken(tokenData: TokenData): Promise<void> {\n\t\tthis.adapter.log.debug('[storeToken#]');\n\t\t// Check if tokenData is available\n\t\tif (!this.tokenData || !this.tokenData.accessToken) {\n\t\t\tthis.adapter.log.warn('[storeToken] No access token available to store');\n\t\t\treturn;\n\t\t}\n\t\t// Store the token in the adapter's native object\n\t\tthis.adapter.extendForeignObject(`system.adapter.${this.adapter.namespace}`, {\n\t\t\tnative: {\n\t\t\t\tactiveToken: this.tokenData,\n\t\t\t\t//activeToken: tokenData,\n\t\t\t},\n\t\t});\n\t}\n\n\tasync initTokenData(): Promise<TokenData> {\n\t\t// Retrieve token Data\n\t\t//return (async () => {\n\n\t\tthis.adapter.log.debug('[initTokenData#]');\n\t\tlet tokenData = await this.getStoredTokenData();\n\n\t\tif (!tokenData) {\n\t\t\ttry {\n\t\t\t\ttokenData = await this.getTokenWithLogin();\n\t\t\t\tthis.storeToken();\n\t\t\t\t//await this.storeToken(tokenData);\n\t\t\t} catch (error) {\n\t\t\t\tthis.adapter.log.error(`[initTokenData] Login failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n\t\t\t\tthrow new Error(`Login failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n\t\t\t}\n\t\t}\n\n\t\tthis.adapter.log.debug(`initTokenData: Tokendata: ${tokenData.expiresAt}`);\n\t\tthis.tokenData = tokenData\n\t\tthis.tokenPromise = null;\n\t\treturn tokenData;\n\t\t//})();\n\t}\n\n\tasync getStoredTokenData(): Promise<TokenData | null> {\n\t\t//this.adapter.log.debug('[getStoredTokenData#]');\n\t\t// Return the stored token data if available\n\t\treturn await this.adapter.getForeignObjectAsync(`system.adapter.${this.adapter.namespace}`)\n\t\t\t.then(obj => {\n\t\t\t\tif (obj && obj.native && obj.native.activeToken) {\n\t\t\t\t\t//this.adapter.log.debug(`[getStoredTokenData] Loaded token data: ${JSON.stringify(obj.native.activeToken)}`);\n\t\t\t\t\tconst tokenData = obj.native.activeToken; // nur tempor\u00E4r\n\t\t\t\t\t//this.adapter.log.debug(`[getStoredTokenData] Loaded token data:${tokenData.accessToken.substring(0, 30)}`);\n\t\t\t\t\tthis.adapter.log.debug(`[getStoredTokenData] Loaded token data expires at: ${tokenData.expiresAt ? this.showTimeStamp(tokenData.expiresAt) : 'N/A'}`);\n\t\t\t\t\treturn {\n\t\t\t\t\t\taccessToken: obj.native.activeToken.accessToken,\n\t\t\t\t\t\trefreshToken: obj.native.activeToken.refreshToken,\n\t\t\t\t\t\tuserId: obj.native.activeToken.userId,\n\t\t\t\t\t\texpiresAt: obj.native.activeToken.expiresAt,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tthis.adapter.log.debug('[getStoredTokenData] No token data found');\n\t\t\t\treturn null;\n\t\t\t});\n\t}\n\n\tprivate showTimeStamp(ts: number): string {\n\t\tconst date = new Date(ts);\n\t\t//const dateString = date.toISOString();\n\t\tconst dateString = date.toLocaleTimeString(); //  .toLocaleDateString();\n\t\t//console.log(dateString);\n\t\treturn dateString;\n\t}\n\n\t/**\n\t * Retrieves the user ID from the token data.\n\t *\n\t * @returns {Promise<number | undefined>} The user ID if available, otherwise undefined.\n\t * @throws {Error} If the token data is not available.\n\t */\n\tasync getUserId(): Promise<number | undefined> {\n\t\tthis.adapter.log.debug('[getUserId#]');\n\t\tconst userId = (await this.tokenData)?.userId;\n\t\tif (userId === undefined) {\n\t\t\tthis.adapter.log.warn('[getUserId] No user ID available in token data');\n\t\t\tthrow new Error('User ID is not available in token data');\n\t\t}\n\t\tthis.adapter.log.debug(`[getUserId] User ID: ${userId}`);\n\t\t// Return the user ID from the token data\n\t\treturn userId;\n\t}\n}\n\n"],
  "mappings": "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",
  "names": []
}
